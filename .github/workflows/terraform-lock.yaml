---
name: terraform-lock

permissions:
  contents: write
  pull-requests: read

on:
  pull_request:
    branches:
      - master
      - main
    paths:
      - "**/versions.tf"
      - "**/.terraform.lock.hcl"
      - "renovate.json"

jobs:
  terraform-lock:
    runs-on: ubuntu-latest
    name: Update Terraform lock files
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Check if commit is from bot
        id: check-bot
        run: |
          if [[ "${{ github.event.pull_request.user.login }}" == "renovate[bot]" ]] || \
             [[ "${{ github.actor }}" == "github-actions[bot]" ]]; then
            echo "is_bot=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_bot=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269571bd # v3
        with:
          terraform_wrapper: false

      - name: Update lock files
        run: |
          LOCK_PLATFORMS="-platform=windows_amd64 -platform=darwin_amd64 -platform=linux_amd64 -platform=darwin_arm64 -platform=linux_arm64"

          # Find all directories containing .terraform.lock.hcl
          for lockfile in $(find . -name ".terraform.lock.hcl" -type f | sort); do
            dir=$(dirname "$lockfile")
            echo "Updating lock file in $dir"
            cd "$dir"
            terraform init -backend=false -upgrade
            terraform providers lock $LOCK_PLATFORMS
            cd - > /dev/null
          done

      - name: Check for changes
        id: git-check
        run: |
          git diff --quiet -- '**/.terraform.lock.hcl' || echo "has_changes=true" >> "$GITHUB_OUTPUT"

      - name: Commit and push changes
        if: steps.git-check.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add '**/.terraform.lock.hcl'
          git commit -m "chore: update terraform lock files for all platforms"
          git push
